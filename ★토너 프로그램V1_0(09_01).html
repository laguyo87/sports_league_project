<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>토너먼트 경기 관리 프로그램</title>
  <style>
    :root{
      --bg-dark: #0d1117;
      --sidebar-bg: #161b22;
      --main-bg: #0d1117;
      --card-bg: #161b22;
      --input-bg: #0d1117;
      --ink: #e6edf3;
      --ink-muted: #7d8590;
      --accent: #58a6ff;
      --accent-fg: #0d1117;
      --line: #30363d;
      --win: #3fb950;
      --lose: #f85149;
      --focus: #58a6ff;

      --completed-r0: rgba(63, 185, 80, 0.1); --completed-r0-border: rgba(63, 185, 80, 0.5);
      --completed-r1: rgba(88, 166, 255, 0.1); --completed-r1-border: rgba(88, 166, 255, 0.5);
      --completed-r2: rgba(173, 139, 255, 0.1); --completed-r2-border: rgba(173, 139, 255, 0.5);
      --completed-r3: rgba(255, 122, 171, 0.1); --completed-r3-border: rgba(255, 122, 171, 0.5);
      --completed-r4: rgba(247, 189, 70, 0.1); --completed-r4-border: rgba(247, 189, 70, 0.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Apple SD Gothic Neo,Malgun Gothic,"Noto Sans KR",sans-serif;
      color:var(--ink); background:var(--bg-dark);
      font-size: 14px;
    }

    /* Main Layout */
    .app-container{ display:flex; height:100vh; }
    .sidebar{
      flex: 0 0 320px; background: var(--sidebar-bg); border-right: 1px solid var(--line);
      display: flex; flex-direction: column; padding: 24px; gap: 20px;
    }
    .main-content{ flex: 1; padding: 24px; display:flex; flex-direction:column; overflow: hidden; }

    /* Sidebar */
    .sidebar-header h2 { font-size: 20px; margin: 0 0 16px 0; padding-bottom: 16px; border-bottom: 1px solid var(--line); }
    .new-tournament-form { display: flex; flex-direction: column; gap: 10px; }
    .sidebar-footer { margin-top: auto; font-size: 12px; color: var(--ink-muted); text-align: center; }

    /* Main Content Header */
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }
    .main-header h1 { font-size: 24px; margin: 0; }
    .theme-toggle { background: none; border: none; color: var(--ink-muted); cursor: pointer; padding: 4px; }
    .theme-toggle svg { width: 20px; height: 20px; }

    /* Placeholder */
    .placeholder-view {
      flex: 1; display: flex; align-items: center; justify-content: center; text-align: center;
      color: var(--ink-muted);
    }
    .placeholder-content { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .placeholder-content svg { width: 64px; height: 64px; }
    .placeholder-content h3 { font-size: 20px; margin: 0; color: var(--ink); }
    .placeholder-content p { margin: 0; }

    /* Generic Controls */
    .field{margin-bottom:12px}
    .field label{display:block; font-size:13px; color:var(--ink-muted); margin-bottom:6px}
    .field input[type="text"], .field textarea, .field select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px;
      background:var(--input-bg); font-size:14px; color: var(--ink);
    }
    .field input[type="text"]:focus, .field textarea:focus { outline: 2px solid var(--focus); border-color: var(--focus); }
    .btn{
      display:inline-flex; align-items:center; justify-content: center; gap:8px; padding:10px 14px;
      border-radius:8px; border:1px solid var(--line);
      background: #21262d; color: var(--ink); cursor:pointer; font-weight:600; transition:.2s;
    }
    .btn.primary{background:var(--accent); color:var(--accent-fg); border-color:var(--accent)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .hint{font-size:12px; color:var(--ink-muted); margin-top:4px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .row .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border:1px solid var(--line); border-radius:20px; cursor:pointer; user-select:none; font-size: 13px;}
    .row .chip input{margin:0}
    .row .chip:has(input:checked) { background-color: var(--accent); color: var(--accent-fg); border-color: var(--accent); }

    /* Tournament List */
    #tournamentList { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; padding: 4px; }
    .tournament-card {
      padding: 12px; border: 1px solid var(--line); border-radius: 8px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      transition: background-color .2s;
    }
    .tournament-card:hover { background: #21262d; }
    .tournament-card.active { border-color: var(--accent); background: rgba(88, 166, 255, 0.1); }
    .tournament-card .name { font-weight: 600; }
    .tournament-card .details { font-size: 12px; color: var(--ink-muted); }
    .tournament-card .delete-btn { font-size: 12px; padding: 4px 8px; background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.4); border-radius: 6px; }

    /* Bracket View */
    .bracket-wrap{
      position:relative; flex:1;
      border:1px solid var(--line); border-radius:10px; padding:16px; overflow:auto;
      background-color: var(--card-bg);
    }
    .svg-layer{position:absolute; inset:0; pointer-events:none}
    .rounds { display: flex; align-items: flex-start; gap: 60px; }
    .round { display: flex; flex-direction: column; justify-content: space-around; flex-grow: 1; min-width: 240px; }
    .round-title { font-weight: 700; font-size: 14px; color: var(--ink-muted); text-align: center; margin-bottom: 16px; }
    .match-group { display: flex; flex-direction: column; justify-content: center; flex-grow: 1; gap: 16px; }

    .match{
      background: var(--bg-dark); border:1px solid var(--line); border-left:4px solid transparent; border-radius:10px; padding:8px; position:relative;
      box-shadow:0 1px 2px rgba(0,0,0,.04); transition: border .2s, background-color .2s;
    }
    .match.completed.completed-r0 { background-color: var(--completed-r0); border-color: var(--completed-r0-border); }
    .match.completed.completed-r1 { background-color: var(--completed-r1); border-color: var(--completed-r1-border); }
    .match.completed.completed-r2 { background-color: var(--completed-r2); border-color: var(--completed-r2-border); }
    .match.completed.completed-r3 { background-color: var(--completed-r3); border-color: var(--completed-r3-border); }
    .match.completed.completed-r4 { background-color: var(--completed-r4); border-color: var(--completed-r4-border); }

    .teams{display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center}
    .team{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; transition:.15s; }
    .team.win{ background:rgba(63, 185, 80, 0.15); font-weight: 600;}
    .team.lose{opacity: .5;}
    .win-badge { color: var(--win); font-weight: bold; font-size: 12px; margin-left: auto; padding-left: 8px; }
    .bye-badge { color: var(--ink-muted); font-weight: bold; font-size: 12px; margin-left: auto; padding-left: 8px; }
    .score{
      width:52px; text-align:center; padding:6px 8px; border:1px solid var(--line); border-radius:8px; font-weight:700;
      background: var(--input-bg); color: var(--ink);
    }
    .bye{color:var(--ink-muted); font-size:12px; padding-left:4px}
    .sr-only{position:absolute; left:-10000px}
  </style>
</head>
<body>

  <div class="app-container">
    <aside class="sidebar">
      <header class="sidebar-header">
        <h2 id="tournaments-title">토너먼트 목록</h2>
      </header>

      <div class="new-tournament-form">
        <input id="newTournamentNameInput" type="text" placeholder="새로운 토너먼트 이름">
        <button id="btnAddNew" class="btn primary">새로운 토너먼트 추가</button>
      </div>

      <div id="tournamentList" role="listbox"></div>

      <section id="settingsPanel" style="display:none;">
        <h3 style="margin: 20px 0 10px; font-size: 16px;">토너먼트 설정</h3>
        <div class="field">
          <label for="tournamentName">토너먼트 이름*</label>
          <input id="tournamentName" type="text" placeholder="예) 2학년 3반 족구 대회" />
        </div>
        <div class="field">
          <label for="sportName">경기 종목*</label>
          <input id="sportName" type="text" placeholder="예) 족구, 피구" />
        </div>
        <div class="field">
          <label>토너먼트 형식*</label>
          <div class="row" role="radiogroup" aria-label="토너먼트 형식">
            <label class="chip"><input type="radio" name="format" value="single" checked> 단판</label>
            <label class="chip"><input type="radio" name="format" value="roundrobin" disabled> 리그(준비중)</label>
          </div>
        </div>
        <div class="field">
          <label for="teamsInput">참가 팀 명단 (한 줄에 한 팀)*</label>
          <textarea id="teamsInput" rows="6" placeholder="청팀&#10;백팀&#10;1조 드림팀&#10;2조 어벤져스"></textarea>
          <div class="hint">빈 줄/중복은 자동 제거됩니다.</div>
        </div>
        <div class="field">
          <label>시드 배정</label>
          <div class="row" role="radiogroup" aria-label="시드 배정">
            <label class="chip"><input type="radio" name="seeding" value="input" checked> 입력 순</label>
            <label class="chip"><input type="radio" name="seeding" value="random"> 무작위</label>
          </div>
        </div>
        <div class="field row">
          <button id="btnBuild" class="btn primary">대진표 생성/업데이트</button>
          <button id="btnReset" class="btn">입력 초기화</button>
        </div>
      </section>

      <footer class="sidebar-footer">
        만든이: 김선폐(laguyo87@gmail.com)
      </footer>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h1>토너먼트 경기</h1>
        <button class="theme-toggle" aria-label="테마 변경">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
      </header>

      <div id="placeholder-view" class="placeholder-view">
        <div class="placeholder-content">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          <h3>생성된 토너먼트를 선택하여 시작하세요</h3>
          <p>왼쪽에서 토너먼트를 선택하거나 새로 만들어주세요.</p>
        </div>
      </div>

      <section id="bracket-container" class="bracket-wrap" style="display: none;">
        <h2 id="bracket-title" class="sr-only">대진표</h2>
        <div id="roundsContainer">
            <div id="rounds" class="rounds" role="list"></div>
        </div>
        <svg id="svgLayer" class="svg-layer" xmlns="http://www.w3.org/2000/svg"></svg>
      </section>
       <div id="statusText" aria-live="polite" style="margin-top: auto; color: var(--ink-muted); font-size: 12px;"></div>
    </main>
  </div>


  <script>
    const appState = { tournaments: [], activeTournamentId: null, };
    let state = {};

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const setStatus = (t)=> $("#statusText").textContent = t || "";

    function generateId() { return 't_' + Date.now().toString(36) + Math.random().toString(36).substring(2); }
    function parseTeams(raw){
      const set = new Set();
      (raw || "").split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(n=> set.add(n));
      return Array.from(set);
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
    function nextPow2(n){ let p=1; while(p<n) p<<=1; return p; }
    
    // --- UI Control ---
    function showPlaceholder() {
      $('#placeholder-view').style.display = 'flex';
      $('#bracket-container').style.display = 'none';
      $('#settingsPanel').style.display = 'none';
    }

    function showBracketView() {
      $('#placeholder-view').style.display = 'none';
      $('#bracket-container').style.display = 'flex';
      $('#settingsPanel').style.display = 'block';
    }

    // --- Core Logic ---
    let matchIdSeq = 1;
    function buildSingleElimination(teams){
      const n = teams.length;
      if (n < 2) return [];
      matchIdSeq = 1;
      const size = nextPow2(n);
      const seeded = state.seeding === "random" ? shuffle([...teams]) : [...teams];
      const firstRoundTeams = Array.from({length: size}, (_, i) => seeded[i] || null);
      const rounds = [];
      let current = [];
      for(let i=0; i<size; i+=2){
        current.push(makeMatch(0, i/2, firstRoundTeams[i], firstRoundTeams[i+1]));
      }
      rounds.push(current);
      let roundIdx = 1;
      while(current.length > 1){
        const next = [];
        for(let i=0; i<current.length; i+=2){
          const parent = makeMatch(roundIdx, i/2, null, null);
          current[i].parentId = parent.id;
          current[i+1].parentId = parent.id;
          next.push(parent);
        }
        rounds.push(next);
        current = next;
        roundIdx++;
      }
      applyByeWinners(rounds);
      return rounds;
    }
    function makeMatch(roundIdx, slotIdx, teamA, teamB){
      return {
        id: "m" + (matchIdSeq++), roundIdx, slotIdx,
        teamA: teamA ?? null, teamB: teamB ?? null,
        scoreA: null, scoreB: null, winner: null, parentId: null
      };
    }
    function applyByeWinners(rounds){
      if (!rounds || !rounds[0]) return;
      for(const match of rounds[0]){
        if(match.teamA && !match.teamB) match.winner = match.teamA;
        else if(!match.teamA && match.teamB) match.winner = match.teamB;
        if(match.winner) pushWinner(match, rounds);
      }
    }
    function findMatchById(id, rounds){
      for(const r of rounds) for(const m of r) if(m.id === id) return m;
      return null;
    }
    function pushWinner(childMatch, rounds){
      if(!childMatch.parentId || !childMatch.winner) return;
      const parent = findMatchById(childMatch.parentId, rounds);
      if(!parent) return;
      if (childMatch.slotIdx % 2 === 0) parent.teamA = childMatch.winner;
      else parent.teamB = childMatch.winner;
    }

    function onScoreInput(matchId, side, value){
      const m = findMatchById(matchId, state.rounds);
      if(!m) return;
      const v = (value === "" ? null : Number(value));
      if(side === "A") m.scoreA = v; else m.scoreB = v;
      const oldWinner = m.winner;
      m.winner = null;
      if(Number.isFinite(m.scoreA) && Number.isFinite(m.scoreB)){
        if(m.scoreA === m.scoreB) setStatus("동점은 허용되지 않습니다.");
        else { m.winner = (m.scoreA > m.scoreB) ? m.teamA : m.teamB; setStatus(""); }
      }
      if(oldWinner !== m.winner) propagateWinners();
      renderRounds();
      doSave();
    }
    function propagateWinners() {
        for(let i=0; i < state.rounds.length -1; i++){
            state.rounds[i].forEach(match => {
                const parent = findMatchById(match.parentId, state.rounds);
                if(!parent) return;
                
                if (match.slotIdx % 2 === 0) parent.teamA = null;
                else parent.teamB = null;
                pushWinner(match, state.rounds);

                if(parent.teamA && !parent.teamB && parent.winner !== parent.teamA) {
                    parent.winner = parent.teamA;
                    propagateWinners();
                }
                if(!parent.teamA && parent.teamB && parent.winner !== parent.teamB) {
                    parent.winner = parent.teamB;
                    propagateWinners();
                }
            });
        }
    }

    function renderRounds(){
      const wrap = $("#rounds");
      wrap.innerHTML = "";
      if(!appState.activeTournamentId || !state || !state.rounds || state.rounds.length === 0){
        let message = appState.activeTournamentId 
            ? "설정에서 정보를 입력하고 '대진표 생성' 버튼을 클릭하세요."
            : "새 토너먼트를 만들거나 목록에서 기존 토너먼트를 선택하세요.";
        wrap.innerHTML = `<p style="color:var(--ink-muted);padding:16px;">${message}</p>`;
        $("#svgLayer").innerHTML = "";
        return;
      }
      
      const labels = makeRoundLabels(state.rounds.length);
      const roundsContainer = $("#rounds");

      state.rounds.forEach((round, rIdx)=>{
        const roundCol = document.createElement("div");
        roundCol.className = "round";
        const title = document.createElement("div");
        title.className = "round-title";
        title.textContent = labels[rIdx] || `R${rIdx+1}`;
        roundCol.appendChild(title);
        
        for (let i = 0; i < round.length; i++) {
            const matchGroup = document.createElement('div');
            matchGroup.className = 'match-group';
            if (rIdx === 0) {
                matchGroup.appendChild(renderMatchCard(round[i], rIdx));
                i++;
                if (round[i]) {
                    matchGroup.appendChild(renderMatchCard(round[i], rIdx));
                }
            } else {
                matchGroup.appendChild(renderMatchCard(round[i], rIdx));
            }
            roundCol.appendChild(matchGroup);
        }
        roundsContainer.appendChild(roundCol);
      });
      requestAnimationFrame(drawSvgLines);
    }
    
    function renderMatchCard(m, rIdx){
      const el = document.createElement("div");
      el.className = "match";
      el.dataset.matchId = m.id;
      if (m.winner) el.classList.add("completed", `completed-r${rIdx}`);

      const aName = m.teamA ?? "(미정)";
      const bName = m.teamB ?? "(미정)";
      const winA = m.winner && m.winner === m.teamA;
      const winB = m.winner && m.winner === m.teamB;
      const isByeMatch = !m.teamA || !m.teamB; 

      el.innerHTML = `
        <div class="teams">
          <div class="team ${winA?'win':(m.winner? 'lose':'')}">
            ${aName ? `<span>${aName}</span>` : `<span class="bye">부전승</span>`}
            ${winA ? (isByeMatch ? '<span class="bye-badge">부전승</span>' : '<span class="win-badge">승</span>') : ''}
          </div>
          <input type="number" inputmode="numeric" class="score" min="0" ${m.teamA && m.teamB ? "" : "disabled"} value="${m.scoreA ?? ''}" aria-label="${aName} 점수" />
          
          <div class="team ${winB?'win':(m.winner? 'lose':'')}">
            ${bName ? `<span>${bName}</span>` : `<span class="bye">부전승</span>`}
            ${winB ? (isByeMatch ? '<span class="bye-badge">부전승</span>' : '<span class="win-badge">승</span>') : ''}
          </div>
          <input type="number" inputmode="numeric" class="score" min="0" ${m.teamA && m.teamB ? "" : "disabled"} value="${m.scoreB ?? ''}" aria-label="${bName} 점수" />
        </div>
      `;
      const [scoreA, scoreB] = el.querySelectorAll(".score");
      scoreA?.addEventListener("input",(e)=> onScoreInput(m.id, "A", e.target.value));
      scoreB?.addEventListener("input",(e)=> onScoreInput(m.id, "B", e.target.value));
      return el;
    }
    function makeRoundLabels(count){
      if(count<=0) return []; if(count===1) return ["결승"]; if(count===2) return ["준결승","결승"];
      if(count===3) return ["8강","4강","결승"]; if(count===4) return ["16강","8강","4강","결승"];
      if(count===5) return ["32강","16강","8강","4강","결승"];
      return Array.from({length:count}, (_,i)=> `R${i+1}`);
    }

    function drawSvgLines(){
      const svg = $("#svgLayer");
      const roundsEl = $("#rounds");
      if(!svg || !roundsEl) return;
      svg.innerHTML = "";
      const scrollW = roundsEl.scrollWidth; const scrollH = roundsEl.scrollHeight;
      svg.setAttribute("viewBox", `0 0 ${scrollW} ${scrollH}`);
      svg.setAttribute("width", scrollW); svg.setAttribute("height", scrollH);
      const roundCols = Array.from(roundsEl.querySelectorAll(".round"));
      if(roundCols.length < 2) return;
      for(let r=0; r < roundCols.length-1; r++){
        const thisRoundCards = Array.from(roundCols[r].querySelectorAll(".match"));
        const nextRoundCards = Array.from(roundCols[r+1].querySelectorAll(".match"));
        thisRoundCards.forEach(card => {
          const m = findMatchById(card.dataset.matchId, state.rounds);
          if(!m || !m.parentId) return;
          const parentCard = nextRoundCards.find(el => el.dataset.matchId === m.parentId);
          if(!parentCard) return;
          const a = getCenterRight(card, roundsEl);
          const b = getCenterLeft(parentCard, roundsEl);
          const path = document.createElementNS("http://www.w3.org/2000/svg","path");
          const dx = Math.abs(b.x - a.x) * 0.5;
          const d = `M ${a.x} ${a.y} C ${a.x + dx} ${a.y}, ${b.x - dx} ${b.y}, ${b.x} ${b.y}`;
          path.setAttribute("d", d);
          path.setAttribute("fill","none");
          path.setAttribute("stroke", m.winner ? "var(--accent)" : "#444");
          path.setAttribute("stroke-width", m.winner ? "2" : "1.5");
          path.setAttribute("stroke-linecap", "round");
          svg.appendChild(path);
        });
      }
    }
    function getCenterRight(el, container){
      const r1 = el.getBoundingClientRect(); const rC = container.getBoundingClientRect();
      return { x: (r1.right - rC.left) + container.scrollLeft, y: (r1.top - rC.top) + r1.height/2 + container.scrollTop };
    }
    function getCenterLeft(el, container){
      const r1 = el.getBoundingClientRect(); const rC = container.getBoundingClientRect();
      return { x: (r1.left - rC.left) + container.scrollLeft, y: (r1.top - rC.top) + r1.height/2 + container.scrollTop };
    }
    window.addEventListener("resize", ()=> requestAnimationFrame(drawSvgLines));
    $("#roundsContainer").addEventListener("scroll", ()=> requestAnimationFrame(drawSvgLines), {passive:true});

    const STORAGE_KEY = "tournament_manager_v3.0";
    function doSave(){
      if (!appState.activeTournamentId) return;
      
      state.name = $("#tournamentName").value.trim();
      state.sport = $("#sportName").value.trim();
      state.teams = parseTeams($("#teamsInput").value);
      state.format = $$("input[name='format']:checked")[0]?.value || 'single';
      state.seeding = $$("input[name='seeding']:checked")[0]?.value || 'input';

      const index = appState.tournaments.findIndex(t => t.id === appState.activeTournamentId);
      if(index > -1) {
        appState.tournaments[index] = { ...state };
      } else {
        appState.tournaments.push({ ...state });
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.tournaments));
      setStatus("자동 저장되었습니다.");
      renderTournamentList();
    }

    function loadApp(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) appState.tournaments = [];
      else try { appState.tournaments = JSON.parse(raw); } catch(e) { appState.tournaments = []; }
      
      renderTournamentList();
      showPlaceholder();
    }

    function doDelete(id_to_delete){
        if (!confirm("정말로 이 토너먼트를 삭제하시겠습니까? 되돌릴 수 없습니다.")) return;
        appState.tournaments = appState.tournaments.filter(t => t.id !== id_to_delete);
        if(appState.activeTournamentId === id_to_delete) {
            appState.activeTournamentId = null;
            state = {};
            resetForm();
            showPlaceholder();
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.tournaments));
        renderTournamentList();
        setStatus("토너먼트를 삭제했습니다.");
    }
    function renderTournamentList() {
        const listEl = $("#tournamentList");
        listEl.innerHTML = "";
        if (appState.tournaments.length === 0) {
            listEl.innerHTML = `<p style="font-size:13px; color:var(--ink-muted); text-align:center; padding:10px;">저장된 토너먼트가 없습니다.</p>`; return;
        }
        appState.tournaments.forEach(t => {
            const card = document.createElement("div");
            card.className = "tournament-card";
            if (t.id === appState.activeTournamentId) card.classList.add("active");
            card.dataset.id = t.id; card.setAttribute('role', 'option');
            card.innerHTML = `
                <div>
                    <div class="name">${t.name || "이름 없는 토너먼트"}</div>
                    <div class="details">${t.sport || "종목 미지정"} · ${t.teams.length}팀</div>
                </div>
                <button class="delete-btn" data-id="${t.id}" aria-label="${t.name} 토너먼트 삭제">삭제</button>
            `;
            card.addEventListener('click', (e) => {
              if (e.target.classList.contains('delete-btn')) {
                doDelete(e.target.dataset.id); e.stopPropagation();
              } else handleSelectTournament(t.id);
            });
            listEl.appendChild(card);
        });
    }
    function build(){
      if (!appState.activeTournamentId) {
        setStatus("활성화된 토너먼트가 없습니다."); return;
      }
      state.name = $("#tournamentName").value.trim(); state.sport = $("#sportName").value.trim();
      state.format = $$("input[name='format']:checked")[0].value; state.seeding = $$("input[name='seeding']:checked")[0].value;
      state.teams = parseTeams($("#teamsInput").value);
      
      if(state.teams.length < 2){ 
        setStatus("팀이 2개 이상 필요합니다."); 
        state.rounds = []; 
      } else {
        state.rounds = (state.format === "single") ? buildSingleElimination(state.teams) : [];
        setStatus("대진표를 생성/업데이트했습니다.");
      }
      renderRounds(); 
      doSave();
    }
    function resetForm(){
      $("#tournamentName").value = state.name ?? ""; $("#sportName").value = ""; $("#teamsInput").value = "";
      $$("input[name='format']").forEach(r=> r.checked = (r.value==="single"));
      $$("input[name='seeding']").forEach(r=> r.checked = (r.value==="input"));
      if(state && state.id) {
          state = { ...state, sport:"", teams: [], rounds: [], seeding:"input", format:"single" };
          renderRounds();
      }
      setStatus("입력 양식을 초기화했습니다.");
    }
    function handleSelectTournament(id) {
      appState.activeTournamentId = id;
      const tournamentData = appState.tournaments.find(t => t.id === id);
      state = JSON.parse(JSON.stringify(tournamentData));
      
      $("#tournamentName").value = state.name ?? ""; $("#sportName").value = state.sport ?? "";
      $("#teamsInput").value = (state.teams ?? []).join("\n");
      $$("input[name='format']").forEach(r=> r.checked = (r.value === state.format));
      $$("input[name='seeding']").forEach(r=> r.checked = (r.value === state.seeding));
      
      showBracketView();
      renderTournamentList(); 
      renderRounds();
      setStatus(`'${state.name}' 토너먼트를 불러왔습니다.`);
    }

    function handleCreateNew() {
        const nameInput = $("#newTournamentNameInput");
        const newName = nameInput.value.trim();
        if (!newName) {
            setStatus("새 토너먼트의 이름을 입력하세요.");
            nameInput.focus();
            return;
        }

        const newId = generateId();
        const newTournament = { id: newId, name: newName, sport: "", format: "single", teams: [], seeding: "input", rounds: [] };
        
        appState.tournaments.unshift(newTournament);
        appState.activeTournamentId = newId;

        nameInput.value = "";
        handleSelectTournament(newId);
    }
    
    $("#btnBuild").addEventListener("click", build);
    $("#btnReset").addEventListener("click", resetForm);
    $("#btnAddNew").addEventListener("click", handleCreateNew);

    loadApp();
  </script>
</body>
</html>

